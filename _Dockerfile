# ============================================================
# Moodle GVA Base - Dockerfile (versi贸 per a alumnes)
# Moodle 4.5 estable + tema Moove + config.php automtic
# ============================================================

FROM php:8.3-apache

# --- Extensions i eines necessries ---
RUN apt-get update && apt-get install -y \
    git unzip mariadb-client libpng-dev libjpeg-dev libfreetype6-dev \
    libxml2-dev libzip-dev libicu-dev libonig-dev libxslt1-dev \
    && docker-php-ext-install mysqli gd intl soap zip xsl bcmath opcache

# --- Apache ---
RUN a2enmod rewrite
RUN echo '<Directory /var/www/html>\n\
    Options Indexes FollowSymLinks\n\
    AllowOverride All\n\
    Require all granted\n\
</Directory>' > /etc/apache2/conf-available/moodle.conf \
    && a2enconf moodle

# --- Configuraci贸 PHP ---
COPY php.ini /usr/local/etc/php/conf.d/php.ini

# --- Configuraci贸 completa d'Apache i PHP per a Moodle GVA ---
RUN apt update && apt install -y git unzip curl libpng-dev libjpeg-dev libfreetype6-dev libzip-dev zlib1g-dev \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd zip mysqli opcache intl \
    && a2enmod rewrite headers expires ssl \
    # Configuraci贸 del directori per permetre .htaccess i PHP
    && echo '<Directory /var/www/html>\n\
	Options Indexes FollowSymLinks\n\
	AllowOverride All\n\
	Require all granted\n\
    </Directory>' > /etc/apache2/conf-available/moodle.conf \

    && a2enconf moodle \
    && service apache2 reload \
    # Neteja per reduir mida de la imatge
    && apt clean && rm -rf /var/lib/apt/lists/*
# --- Idiomes i permisos Moodle GVA ---
RUN cd /var/www/html \
    && php admin/cli/langinstall.php ca_valencia es en || true \
    && php admin/cli/purge_caches.php || true \
    && chown -R www-data:www-data /var/www/html /var/www/moodledata






# --- Descarregar Moodle 4.5 estable ---
RUN git clone -b MOODLE_405_STABLE https://github.com/moodle/moodle.git /var/www/html \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# --- Instal路lar tema Moove ---
RUN cd /var/www/html/theme && \
    git clone https://github.com/willianmano/moodle-theme_moove.git moove && \
    chown -R www-data:www-data /var/www/html/theme/moove

# --- Copiar config.php base ---
COPY config.php /var/www/html/config.php
RUN chown www-data:www-data /var/www/html/config.php && chmod 640 /var/www/html/config.php

# --- Crear dades persistents ---
RUN mkdir -p /var/www/moodledata && \
    chown -R www-data:www-data /var/www/moodledata && \
    chmod -R 770 /var/www/moodledata

# --- Ajustos GVA per a Moodle ---
RUN apt update && apt install -y git unzip curl \
 && cd /var/www/html \
 # Instal路lem idiomes essencials (valenci, castell i angl猫s)
 && php admin/cli/langinstall.php ca_valencia es en || true \
 # Purguem cach茅s per deixar el sistema net
 && php admin/cli/purge_caches.php || true \
 # Assegurem permisos correctes
 && chown -R www-data:www-data /var/www/html /var/www/moodledata


# ---  AFEGIT: Idiomes + Upgrade automtic + Purge ---
RUN apt-get install -y sudo && \
    sudo -u www-data php /var/www/html/admin/cli/langinstall.php ca es en || true && \
    sudo -u www-data php /var/www/html/admin/cli/upgrade.php --non-interactive --allow-unstable || true && \
    sudo -u www-data php /var/www/html/admin/cli/purge_caches.php || true

# --- Garantir que el tema Boost existeix (per compatibilitat amb Moove) ---
RUN cd /var/www/html/theme && \
    rm -rf boost && \
    git clone -b MOODLE_405_STABLE https://github.com/moodle/moodle.git tmp && \
    cp -r tmp/theme/boost . && \
    rm -rf tmp && \
    chown -R www-data:www-data /var/www/html/theme/boost

# --- Idiomes + Upgrade + Purge + Neteja de plugins ---
RUN apt-get install -y sudo && \
    sudo -u www-data php /var/www/html/admin/cli/langinstall.php ca es en || true && \
    sudo -u www-data php /var/www/html/admin/cli/upgrade.php --non-interactive --allow-unstable || true && \
    sudo -u www-data php /var/www/html/admin/cli/purge_caches.php || true && \
    #  Reinstal路lar tema Boost per compatibilitat amb Moove
    cd /var/www/html/theme && \
    rm -rf boost && \
    git clone -b MOODLE_405_STABLE https://github.com/moodle/moodle.git tmp && \
    cp -r tmp/theme/boost . && \
    rm -rf tmp && \
    chown -R www-data:www-data /var/www/html/theme/boost && \
    # Ч Eliminar plugin local 'auleslook' si est registrat per貌 no t茅 fitxers
    sudo -u www-data php /var/www/html/admin/cli/uninstall.php --name=local_auleslook --non-interactive || true


EXPOSE 80
CMD ["apache2-foreground"]

